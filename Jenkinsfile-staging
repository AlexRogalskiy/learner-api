/* groovylint-disable CompileStatic,NestedBlockDepth */

pipeline {
    agent any

    parameters {
        RESTList(
            name: 'project',
            description: 'postman/learner-api/',
            restEndpoint: 'https://jenkins.zoinks.dev/job/postman/job/learner-api/view/tags/api/json',
            credentialId: 'jenkins-api-key',
            mimeType: 'APPLICATION_JSON',
            valueExpression: '$.jobs..name',
            filter: 'v[0-9]+\\..+'
        )
        buildSelector(name: 'build')
    }

    options {
        preserveStashes()
    }

    stages {
        stage('copy artifacts') {
            steps {
                copyArtifacts(
                    projectName: "postman/learner-api/${params.project}",
                    selector: buildParameter('build')
                )
            }
        }

        stage('load, tag, and push docker image') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'github-container-registry',
                    usernameVariable: 'GH_USER',
                    passwordVariable: 'GH_TOKEN')]
                ) {
                    sh 'echo "$GH_TOKEN" | docker login ghcr.io -u "$GH_USER" --password-stdin'
                }

                script {
                    loadResult = sh(
                        returnStdout: true,
                        script: 'gunzip -c learner-api-*.tar.gz | docker load'
                    ).trim()
                    echo loadResult
                    imageName = loadResult[14..loadResult.size() - 1]
                    echo imageName
                    taggedImageName = imageName[0..imageName.lastIndexOf(':')] + 'staging'
                    echo taggedImageName
                }

                sh "docker rmi ${taggedImageName} || true"
                sh "docker tag ${imageName} ${taggedImageName}"
                sh "docker push ${taggedImageName}"
            }
        }
    }

    post {
        always {
            slackSend(channel: '#release', blocks: [
                [
                    'type': 'section',
                    'text': [
                        'type': 'mrkdwn',
                        'text': "Hello, Assistant to the Regional Manager Dwight! *Michael Scott* wants to know where you'd like to take the Paper Company investors to dinner tonight.\n\n *Please select a restaurant:*"
                    ]
                ],
                [
                    'type': 'divider'
                ],
                [
                    'type': 'section',
                    'text': [
                        'type': 'mrkdwn',
                        'text': '*Farmhouse Thai Cuisine*\n:star::star::star::star: 1528 reviews\n They do have some vegan options, like the roti and curry, plus they have a ton of salad stuff and noodles can be ordered without meat!! They have something for everyone here'
                    ],
                    'accessory': [
                        'type': 'image',
                        'image_url': 'https://s3-media3.fl.yelpcdn.com/bphoto/c7ed05m9lC2EmA3Aruue7A/o.jpg',
                        'alt_text': 'alt text for image'
                    ]
                ]
            ])
        }
    }
}
